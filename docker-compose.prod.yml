version: "3.7"

services:

    frontend:
        image: "airstorage/frontend:prod"
        build:
            target: prod
            context: ./frontend

    backend:
        command: gunicorn server:app --bind 0.0.0.0:80 --workers 2
        image: "airstorage/backend:prod"
        build:
            target: prod
            context: ./backend
        labels:
            - "traefik.enable=false"
        volumes:
            - ./backend/database.db:/usr/src/app/database.db
    
    nginx:
        command: nginx -g "daemon off";
        image: "airstorage/nginx:prod"
        build:
            target: prod
            context: ./nginx
        networks:
            - public
        labels:
            - "traefik.enable=true"
            - "traefik.backend=airstorage-nginx"
            - "traefik.frontend.rule=Host:airstorage.nl"
            - "traefik.port=80"
            - "traefik.docker.network=public"

networks:
    private:
        external:
            name: private
    public:
        external:
            name: public
